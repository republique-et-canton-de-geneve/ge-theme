variables:
  GIT_STRATEGY: clone
  GIT_SSL_NO_VERIFY: "true"
  GIT_SUBMODULE_STRATEGY: recursive

  HTTP_PROXY: 'http://proxygeadm.etat-ge.ch:3128'
  HTTPS_PROXY: 'http://proxygeadm.etat-ge.ch:3128'
  NO_PROXY: 'localhost,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,10.145.38.211,.ceti.etat-ge.ch,registry.devops.etat-ge.ch'

  YARN_REGISTRY: 'https://registry.devops.etat-ge.ch/ctinexus/repository/npmjs/'
  NPM_REGISTRY: 'https://registry.devops.etat-ge.ch/ctinexus/repository/npmjs/'

  GIT_REPOSITORY: DEVELOPPEUR-EDG/ui
  OCI_SNAPSHOT_URL: 'oci-snapshot.devops.etat-ge.ch'
  OCI_RELEASE_URL: 'oci-release.devops.etat-ge.ch'
  BUILDAH: ${DOCKER_URL}/buildah/stable:v1.32.0
  GITLAB_PATH: git.devops.etat-ge.ch/gitlab

  IMAGE_NAME: "ch/ge/common/web/ge-theme"

default:
  image:
    name: docker-all.devops.etat-ge.ch/ch/ge/cti/build/alpine-maven-git-node:21
  tags:
    - 'for:container-image'
    - 'host:privileged-container'
    - 'net:gold-dev'

stages:
  - snapshot
  - snapshot-upload
  - snapshot-deploy
  - release
  - release-upload

cache:
  untracked: false
  key: "$CI_PROJECT_ID"

snapshot:
  stage: snapshot
  before_script:
    - git config --global user.email ${RUNNER_EMAIL}
    - git config --global user.name ${RUNNER_USERNAME}
  script:
    - IMAGE_VERSION=`node -e "console.log(require('./package.json').version);"`
    - echo "Building version" $IMAGE_VERSION
    - echo $IMAGE_VERSION > version.txt
    - yarn config set "strict-ssl" false
    - yarn config set yarn-registry ${YARN_REGISTRY}
    - "[ ! -d .yarn ] && mkdir .yarn"
    - yarn config set cache-folder .yarn
    - yarn install --network-timeout 600000
    - yarn browserslist --update-db
    - CI= yarn build
    - yarn config set version-git-message "[skip ci] v%s"
    - yarn version --no-git-tag-version --prerelease --preid SNAPSHOT
    - git push https://${SCM_USER}:${SCM_PASSWORD}@${GITLAB_PATH}/${GIT_REPOSITORY}/${CI_PROJECT_NAME}.git/ HEAD:develop  --tags
  artifacts:
    paths:
      - build
      - version.txt
    expire_in: 24h
  allow_failure: false
  except:
    - master

docker-upload-snapshot:
  stage: snapshot-upload
  image: ${BUILDAH}
  before_script:
    - buildah version
    - IMAGE_VERSION=`cat version.txt`
    - buildah login --username ${NEXUS_REPO_USER} --password ${NEXUS_REPO_PASS} "${OCI_SNAPSHOT_URL}"
  script:
    - buildah bud -f Dockerfile --format docker -t "${OCI_SNAPSHOT_URL}/${IMAGE_NAME}:${IMAGE_VERSION}" -t "${OCI_SNAPSHOT_URL}/${IMAGE_NAME}:latest" .
    - buildah push "${OCI_SNAPSHOT_URL}/${IMAGE_NAME}:${IMAGE_VERSION}"
    - buildah push "${OCI_SNAPSHOT_URL}/${IMAGE_NAME}:latest"
  after_script:
    - buildah logout "${OCI_SNAPSHOT_URL}"
  artifacts:
    paths:
      - version.txt
    expire_in: 24h
  dependencies:
    - snapshot
  except:
    - master

deploy-snapshot:
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
  needs:
    - "docker-upload-snapshot"
  variables:
    PIPELINE_NAME: 11487_getheme_dev_oci
    PIPELINE_STAGE: dev
  stage: snapshot-deploy
  image: ch/ge/common/int/python/gocd-schedule:2.0.0
  script:
    - python /app/schedule.py --token=7147e5a924a1bb86b9c4bf8b8f0c6c36cdc5cdfd --pipeline_name=${PIPELINE_NAME} --pipeline_stage=${PIPELINE_STAGE} --pipeline_env_vars=LATEST=${CI_COMMIT_SHA}

release:
  stage: release
  before_script:
    - git config --global user.email ${RUNNER_EMAIL}
    - git config --global user.name ${RUNNER_USERNAME}
    - git config pull.rebase true
  script:
    - git pull origin main
    - IMAGE_VERSION=`node -e "console.log(require('./package.json').version);"`
    - echo "Building version" $IMAGE_VERSION
    - echo $IMAGE_VERSION > version.txt
    - yarn config set "strict-ssl" false
    - yarn config set yarn-registry ${YARN_REGISTRY}
    - "[ ! -d .yarn ] && mkdir .yarn"
    - yarn config set cache-folder .yarn
    - yarn install --network-timeout 600000
    - yarn browserslist --update-db
    - CI= yarn build
    - yarn config set version-git-message "[skip ci] v%s"
    - yarn version --patch
    - git push https://${SCM_USER}:${SCM_PASSWORD}@${GITLAB_PATH}/${GIT_REPOSITORY}/${CI_PROJECT_NAME}.git/ HEAD:main  --tags
  artifacts:
    paths:
      - build
      - version.txt
    expire_in: 1h
  dependencies:
    - snapshot
  when: manual
  allow_failure: false
  except:
    - master


docker-upload-release:
  stage: release-upload
  image: ${BUILDAH}
  before_script:
    - buildah version
    - IMAGE_VERSION=`cat version.txt`
    - buildah login --username ${NEXUS_REPO_USER} --password ${NEXUS_REPO_PASS} "${OCI_RELEASE_URL}"
  script:
    - buildah bud -f Dockerfile --format docker -t "${OCI_RELEASE_URL}/${IMAGE_NAME}:${IMAGE_VERSION}" .
    - buildah push "${OCI_RELEASE_URL}/${IMAGE_NAME}:${IMAGE_VERSION}"
  after_script:
    - buildah logout "${OCI_RELEASE_URL}"
  artifacts:
    paths:
      - version.txt
    expire_in: 24h
  dependencies:
    - release
  except:
    - master

